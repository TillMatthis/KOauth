# Debugging Claude MCP OAuth Connection Issues

## Understanding the Problem

Claude.ai supports **two OAuth modes** for custom connectors:

### Mode 1: Pre-configured Client Credentials (Advanced Settings)
When you provide OAuth Client ID and Client Secret in Claude's "Advanced settings":
1. **Claude uses your pre-configured client** - The one you manually created
2. **You control the client ID and secret** - Set in KOauth and Claude settings
3. **Redirect URI must match exactly** - Claude typically uses `https://claude.ai/oauth/callback`

### Mode 2: Dynamic Client Registration (No Credentials)
When you don't provide credentials in Advanced settings:
1. **Claude registers automatically** - Creates its own client dynamically
2. **Claude uses its own client ID** - Auto-generated by Claude
3. **Redirect URI must match exactly** - Claude typically uses `https://claude.ai/oauth/callback`

**Important:** Based on the [official documentation](https://support.claude.com/en/articles/11175166-getting-started-with-custom-connectors-using-remote-mcp), you can optionally specify OAuth Client ID and Client Secret in "Advanced settings" when adding a connector. If you provided these, Claude will use your pre-configured client instead of dynamically registering.

## Common Issues

### Issue 1: Pre-configured Client vs Dynamic Registration

**Symptom:** You manually created "claude-mcp" client and added credentials to Claude, but connection still fails.

**Possible Causes:**
- If you provided credentials in Advanced settings: Claude should use your client, but redirect URI might not match
- If you didn't provide credentials: Claude dynamically registers with a different client ID
- Client ID/Secret mismatch between KOauth and Claude settings

**Solution:** 
- **If using pre-configured client:** Verify the Client ID and Secret match exactly in both KOauth and Claude's Advanced settings
- **If using dynamic registration:** Check what client Claude actually registered with in logs
- **In both cases:** Ensure redirect URIs match exactly (typically `https://claude.ai/oauth/callback`)

### Issue 2: Redirect URI Mismatch

**Symptom:** Authorization redirects back to Claude but connection status doesn't change.

**Cause:** The redirect URI used during authorization doesn't match Claude's registered redirect URIs.

**Solution:**
1. Check what redirect URI Claude registered with
2. Verify the redirect URI in authorization logs matches exactly
3. Update the client's redirect URIs if needed

### Issue 3: Authorization Code Not Exchanged

**Symptom:** Authorization succeeds but token exchange fails.

**Cause:** 
- Authorization code expired (10 minute lifetime)
- Code already used (single-use only)
- Redirect URI mismatch during token exchange

**Solution:**
- Check server logs for token exchange errors
- Verify authorization code wasn't already used
- Ensure redirect URI matches exactly during token exchange

## Debugging Steps

### Step 1: Check Server Logs

Look for these log entries in your KOauth server logs:

```bash
# View recent logs
docker-compose logs -f koauth | grep -i oauth

# Or if running directly
tail -f /path/to/logs | grep -i oauth
```

**Key log entries to look for:**

1. **Client Registration:**
   ```
   OAuth client registration request
   clientId: <claude-generated-id>
   redirectUris: ["https://claude.ai/oauth/callback"]
   ```

2. **Authorization Request:**
   ```
   OAuth authorize request
   clientId: <client-id>
   redirectUri: <redirect-uri>
   ```

3. **Redirect URI Validation:**
   ```
   Invalid redirect_uri - redirect URI mismatch
   requestedRedirectUri: <what-claude-sent>
   allowedRedirectUris: [<what-client-has>]
   ```

4. **Token Exchange:**
   ```
   Authorization code exchange failed
   possibleReasons: [...]
   ```

### Step 2: Check Registered OAuth Clients

If your database is accessible, run:

```bash
npm run oauth:diagnose -- --all
```

This shows:
- All registered OAuth clients
- Their redirect URIs
- Recent authorization attempts
- Token exchanges
- Potential issues

### Step 3: Check Specific Client

If you know Claude's client ID:

```bash
npm run oauth:diagnose -- --client-id <claude-client-id>
```

Or view client details:

```bash
npm run oauth:update-client <client-id> --view
```

### Step 4: Fix Redirect URI Issues

If redirect URIs don't match:

```bash
# Update redirect URIs for Claude's client
npm run oauth:update-client <claude-client-id> --redirect-uris "https://claude.ai/oauth/callback"

# Mark as trusted (skip consent screen)
npm run oauth:update-client <claude-client-id> --trusted

# Activate client
npm run oauth:update-client <claude-client-id> --active
```

### Step 5: Check Authorization Codes

Look for authorization codes that were created but never used:

```bash
npm run oauth:diagnose -- --client-id <claude-client-id>
```

Check for:
- ⏰ Expired codes (never exchanged)
- ✅ Used codes (successfully exchanged)
- ⏳ Pending codes (waiting for exchange)

## Expected OAuth Flow

### Flow with Pre-configured Credentials (Advanced Settings)

1. **User adds connector in Claude** with OAuth Client ID and Secret in Advanced settings
2. **Claude requests metadata:** `GET https://your-mcp-server/.well-known/oauth-protected-resource`
3. **MCP server returns metadata** pointing to KOauth
4. **Claude discovers KOauth:** `GET https://koauth/.well-known/oauth-authorization-server`
5. **User clicks "Connect"** → Claude uses your pre-configured Client ID/Secret
6. **Claude redirects to KOauth:** `/oauth/authorize?client_id=<your-client-id>&redirect_uri=https://claude.ai/oauth/callback`
7. **KOauth authorization:** User logs in and approves
8. **KOauth redirects back:** `https://claude.ai/oauth/callback?code=...&state=...`
9. **Claude exchanges code:** `POST https://koauth/oauth/token` with your Client ID/Secret
10. **Claude stores tokens** and marks connection as active

### Flow with Dynamic Registration (No Credentials)

1. **Claude requests metadata:** `GET https://your-mcp-server/.well-known/oauth-protected-resource`
2. **MCP server returns metadata** pointing to KOauth
3. **Claude discovers KOauth:** `GET https://koauth/.well-known/oauth-authorization-server`
4. **Claude registers dynamically:** `POST https://koauth/oauth/register`
   - Client ID: Auto-generated by Claude
   - Redirect URI: `https://claude.ai/oauth/callback` (typically)
5. **User clicks "Connect"** → Claude redirects to KOauth
6. **KOauth authorization:** User logs in and approves
7. **KOauth redirects back:** `https://claude.ai/oauth/callback?code=...&state=...`
8. **Claude exchanges code:** `POST https://koauth/oauth/token`
9. **Claude stores tokens** and marks connection as active

## What to Check in Logs

### Successful Flow Logs

```
✅ OAuth client registration request
✅ Redirect URI validated successfully
✅ Authorization approved, redirecting back to client
✅ Authorization code exchanged successfully - tokens issued
```

### Failed Flow Logs

```
❌ Invalid redirect_uri - redirect URI mismatch
❌ Authorization code exchange failed
❌ Invalid client credentials
```

## Quick Fixes

### Fix 1: Update Redirect URIs

```bash
# Find Claude's client ID from logs or database
CLIENT_ID=$(npm run oauth:diagnose -- --all | grep -i claude | head -1 | awk '{print $3}')

# Update redirect URIs
npm run oauth:update-client $CLIENT_ID --redirect-uris "https://claude.ai/oauth/callback"

# Mark as trusted
npm run oauth:update-client $CLIENT_ID --trusted
```

### Fix 2: Check Client Status

```bash
# View all clients
npm run oauth:diagnose -- --all

# Check if client is active
npm run oauth:update-client <client-id> --view
```

### Fix 3: Clear Old Authorization Codes

If you have expired codes causing issues, they'll automatically expire. But you can check:

```bash
npm run oauth:diagnose -- --client-id <client-id>
```

## Testing the Connection

1. **Clear browser cookies** for claude.ai
2. **Go to Claude settings** → Custom Connectors
3. **Click "Connect"** for your MCP server
4. **Watch server logs** in real-time
5. **Check for errors** in the logs

## Common Redirect URIs

Claude typically uses:
- `https://claude.ai/oauth/callback` (most common)
- `https://claude.ai/oauth/redirect` (some versions)

Check your logs to see what Claude actually registered with.

## Still Having Issues?

1. **Check server logs** for detailed error messages
2. **Run diagnostics:** `npm run oauth:diagnose -- --all`
3. **Verify redirect URIs** match exactly (including trailing slashes, protocols)
4. **Check client status:** Active, trusted, redirect URIs
5. **Review authorization codes:** Expired, used, pending

## Environment Variables

Make sure these are set correctly:

```bash
# KOauth
JWT_ISSUER=https://auth.tillmaessen.de  # Must match your KOauth URL
JWT_AUDIENCE=claude-mcp                  # Or whatever Claude expects

# MCP Server
KOAUTH_URL=https://auth.tillmaessen.de
BASE_URL=https://mcp.tillmaessen.de
```

## Next Steps

1. Check server logs for OAuth activity
2. Run `npm run oauth:diagnose -- --all` to see registered clients
3. Verify redirect URIs match exactly
4. Check if authorization codes are being created and exchanged
5. Review error messages in logs for specific failure reasons
